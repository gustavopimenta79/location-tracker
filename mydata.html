<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Miluc√£o - Dashboard</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 16px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); overflow: hidden; }
        .header { background: #218085; color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 32px; margin-bottom: 5px; }
        .controls { padding: 20px 30px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
        button { background: #218085; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; margin-right: 10px; }
        button:hover { background: #1d7480; }
        #stats { padding: 20px 30px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; background: #f1f5f9; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .stat-number { font-size: 36px; font-weight: bold; color: #218085; }
        .stat-label { color: #64748b; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; }
        #dataTable { padding: 0 30px 30px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: #218085; color: white; padding: 15px 12px; text-align: left; font-weight: 600; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; }
        td { padding: 14px 12px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        tr:hover { background: #f8fafc; }
        .coords { font-family: 'Courier New', monospace; font-weight: 600; }
        .map-link { color: #218085; text-decoration: none; font-weight: 600; }
        .map-link:hover { text-decoration: underline; }
        .loading { text-align: center; padding: 60px; color: #64748b; font-size: 18px; }
        .empty { text-align: center; padding: 60px; color: #64748b; }
        .back { padding: 20px 30px; }
        a { color: #218085; text-decoration: none; font-weight: 600; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Miluc√£o Dashboard</h1>
            <p>Registros de localiza√ß√£o dos amig√µes</p>
        </div>

        <div class="controls">
            <button onclick="loadData()">üîÑ Atualizar</button>
            <span id="lastUpdate">-</span>
        </div>

        <div id="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalRegs">0</div>
                <div class="stat-label">Total Registros</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="uniqueDevices">0</div>
                <div class="stat-label">Dispositivos</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="todayRegs">0</div>
                <div class="stat-label">Hoje</div>
            </div>
        </div>

        <div id="dataTable">
            <div class="loading">üîÑ Carregando dados...</div>
        </div>

        <div class="back">
            <a href="/">‚Üê Voltar para cadastro</a>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
        import { getDatabase, ref, get } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAueHmQZ8DbpOl2ZnS4p7zw5kLyNGJ4K8o",
            authDomain: "location-tracker-e3ee8.firebaseapp.com",
            projectId: "location-tracker-e3ee8",
            storageBucket: "location-tracker-e3ee8.firebasestorage.app",
            messagingSenderId: "362391545154",
            appId: "1:362391545154:web:c9d60b45370e304f9554db",
            databaseURL: "https://location-tracker-e3ee8-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        async function loadData() {
            const tableDiv = document.getElementById('dataTable');
            tableDiv.innerHTML = '<div class="loading">üîÑ Carregando dados...</div>';

            try {
                const snapshot = await get(ref(db, 'locations'));

                if (!snapshot.exists()) {
                    tableDiv.innerHTML = '<div class="empty">Nenhum registro ainda. Cadastre o primeiro amig√£o!</div>';
                    updateStats({});
                    return;
                }

                const data = snapshot.val();
                updateStats(data);
                document.getElementById('lastUpdate').textContent = `Atualizado: ${new Date().toLocaleString('pt-BR')}`;

                let tableHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Data/Hora</th>
                                <th>Device ID</th>
                                <th>GPS</th>
                                <th>Precis√£o</th>
                                <th>OS</th>
                                <th>Conex√£o</th>
                                <th>IP</th>
                                <th>üó∫Ô∏è Mapa</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                Object.entries(data)
                    .sort(([a, itemA], [b, itemB]) => new Date(itemB.dataHora) - new Date(itemA.dataHora))
                    .slice(0, 100)
                    .forEach(([key, item]) => {
                        const mapsUrl = `https://www.google.com/maps?q=${item.latitude},${item.longitude}`;
                        tableHTML += `
                            <tr>
                                <td>${item.dataHora || 'N/A'}</td>
                                <td>${item.deviceId || 'N/A'}</td>
                                <td class="coords">${item.latitude || ''}, ${item.longitude || ''}</td>
                                <td>${item.accuracy || 'N/A'}m</td>
                                <td>${item.os || 'N/A'}</td>
                                <td>${item.connection || 'N/A'}</td>
                                <td>${item.publicIp || 'N/A'}</td>
                                <td><a href="${mapsUrl}" target="_blank" class="map-link">Abrir ‚Üí</a></td>
                            </tr>
                        `;
                    });

                tableHTML += '</tbody></table>';
                tableDiv.innerHTML = tableHTML;

            } catch (error) {
                console.error('Erro:', error);
                tableDiv.innerHTML = '<div class="empty">‚ùå Erro ao carregar dados. Verifique a conex√£o.</div>';
            }
        }

        function updateStats(data) {
            const entries = Object.entries(data);
            const total = entries.length;
            const devices = new Set(entries.map(([k, v]) => v.deviceId)).size;
            const today = entries.filter(([k, v]) => {
                const date = new Date(v.dataHora);
                return date.toDateString() === new Date().toDateString();
            }).length;

            document.getElementById('totalRegs').textContent = total;
            document.getElementById('uniqueDevices').textContent = devices;
            document.getElementById('todayRegs').textContent = today;
        }

        setInterval(loadData, 30000);
        loadData();
    </script>
</body>
</html>
